name: Deploy to Production

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Deploy to EC2 via SSH (Compose v2, non-interactive)
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ubuntu
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REPO: ${{ github.repository }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          set -euo pipefail
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          # Use a quoted heredoc so nothing expands on the runner
          # Pass values into the remote shell via environment.
          set +e
          SSH_CMD=$(cat <<'EOF'
            set -euxo pipefail

            export REPO="${REPO}"
            export DOCKER_USERNAME="${DOCKER_USERNAME:-}"
            export DOCKER_PASSWORD="${DOCKER_PASSWORD:-}"

            # 1) Ensure Docker
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl enable --now docker
            fi

            # 2) Ensure Compose v2 (use sudo for compose)
            if ! sudo docker compose version >/dev/null 2>&1; then
              echo "Installing Docker Compose v2…"
              sudo apt-get update || true
              if sudo apt-get install -y docker-compose-plugin; then
                :
              else
                # Fallback: download static binary
                sudo mkdir -p /usr/local/lib/docker/cli-plugins
                sudo curl -fsSL \
                  "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64" \
                  -o /usr/local/lib/docker/cli-plugins/docker-compose
                sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              fi
            fi

            # 3) Get/Update repo
            cd /home/ubuntu
            if [ ! -d app/.git ]; then
              git clone "https://github.com/${REPO}.git" app
            fi
            cd app
            git pull origin main

            # 4) Optional Docker Hub login (private repos)
            if [ -n "${DOCKER_USERNAME}" ] && [ -n "${DOCKER_PASSWORD}" ]; then
              echo "${DOCKER_PASSWORD}" | sudo docker login -u "${DOCKER_USERNAME}" --password-stdin || true
            fi

            # 5) Deploy with compose
            sudo docker compose down --remove-orphans || true
            sudo docker compose pull || true
            sudo docker compose up -d --force-recreate --remove-orphans
            sudo docker system prune -af || true

            # 6) Local health check (allow warmup)
            for i in $(seq 1 30); do
              if curl -fsS http://localhost/health >/dev/null; then
                echo "Local health OK"
                exit 0
              fi
              echo "…waiting for app ($i/30)"
              sleep 2
            done
            echo "Local health check failed"
            exit 1
          EOF
          )
          # Run the SSH with env passed in; capture exit code but don't fail this step
          ssh -o StrictHostKeyChecking=no -i private_key.pem \
            -o LogLevel=ERROR \
            ${USER}@${HOST} \
            REPO="${REPO}" DOCKER_USERNAME="${DOCKER_USERNAME}" DOCKER_PASSWORD="${DOCKER_PASSWORD}" \
            "bash -lc '${SSH_CMD//\'/\'\"\'\"\'}'"
          rc=$?
          set -e
          echo "SSH finished with code: $rc (continuing; public verify will decide pass/fail)"
          rm -f private_key.pem

      - name: Verify deployment from runner (public)
        run: |
          set -e
          for i in $(seq 1 30); do
            if curl -fsS "http://${{ secrets.EC2_HOST }}/health" >/dev/null; then
              echo "✅ Public health OK"
              exit 0
            fi
            echo "…waiting for public /health ($i/30)"
            sleep 2
          done
          echo "❌ Public health check failed"
          exit 1
