      - name: Deploy to EC2 via SSH (Compose v2, non-interactive)
        env:
          HOST: ${{ secrets.EC2_HOST }}
          USER: ubuntu
          PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
          REPO: ${{ github.repository }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
        run: |
          set -euo pipefail
          echo "$PRIVATE_KEY" > private_key.pem
          chmod 600 private_key.pem

          ssh -o StrictHostKeyChecking=no -i private_key.pem ${USER}@${HOST} << EOF
            set -euxo pipefail

            # 1) Ensure Docker
            if ! command -v docker >/dev/null 2>&1; then
              sudo apt-get update
              sudo apt-get install -y docker.io
              sudo systemctl enable --now docker
            fi

            # 2) Ensure Compose v2 (use sudo for checks/calls)
            if ! sudo docker compose version >/dev/null 2>&1; then
              echo "Installing Docker Compose v2…"
              sudo apt-get update || true
              if sudo apt-get install -y docker-compose-plugin; then
                :
              else
                # Hard-code version to avoid runner-side expansion issues
                sudo mkdir -p /usr/local/lib/docker/cli-plugins
                sudo curl -fsSL \
                  "https://github.com/docker/compose/releases/download/v2.29.7/docker-compose-linux-x86_64" \
                  -o /usr/local/lib/docker/cli-plugins/docker-compose
                sudo chmod +x /usr/local/lib/docker/cli-plugins/docker-compose
              fi
            fi

            # 3) Get/Update app repo
            cd /home/ubuntu
            if [ ! -d app/.git ]; then
              git clone https://github.com/${REPO}.git app
            fi
            cd app
            git pull origin main

            # 4) Optional Docker Hub login (private repos)
            if [ -n "${DOCKER_USERNAME}" ] && [ -n "${DOCKER_PASSWORD}" ]; then
              echo "${DOCKER_PASSWORD}" | sudo docker login -u "${DOCKER_USERNAME}" --password-stdin || true
            fi

            # 5) Deploy
            sudo docker compose down --remove-orphans || true
            sudo docker compose pull || true
            sudo docker compose up -d --force-recreate --remove-orphans
            sudo docker system prune -af || true

            # 6) Local health check
            for i in {1..30}; do
              if curl -fsS http://localhost/health >/dev/null; then
                echo "Local health OK"
                exit 0
              fi
              echo "…waiting for app (\$i/30)"
              sleep 2
            done
            echo "Local health check failed"
            exit 1
          EOF

          rm -f private_key.pem
